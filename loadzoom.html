<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>加载天地图绽放级别</title>
	<script type="text/javascript" src="http://api.tianditu.com/js/maps.js"></script>
	<script type="text/javascript" src="libs/jquery-1.11.2.min.js"></script>
</head>
<style type="text/css">
	.opt_station_hover{
		background: rgb(77,103,130);
		font-size: 12px;
		width: 150px;
		height: 47px;
		border-radius: 5px;
	}
	.opt_station_hover_ul{
		list-style: none;
		margin: 0;
		padding: 0;
		line-height: 23px;
		text-indent: 4px;
		color: white;
		position: relative;
	}
	.opt_station_hover_ul li{
		list-style: none;
		margin: 0;
		padding: 0;
		overflow: hidden;
		height: 23px;
	}
	.opt_station_hover img{
		position: absolute;
		left: 50%;
		margin-left: -5px;
	}
	.opt_li_left{
		width: 65px;
		display: bolck;
		float: left;
		text-align: right;
	}

</style>
<body onload="">
	<style type="text/css">
		#mapDiv{
			height:600px;
			width: 100%;
			border: 1px solid #ccc;
		}
	</style>
	<div id="mapDiv"></div>

	<script type="text/javascript">

		var map;
		// var cenL="113.3893";  //默认中心坐标经度
		// var cenB="23.04954"; //默认中心坐标纬度
		// var zoom=10; //默认缩放级别
		var lnglats = [
		{"B":"23.1","L":"113.3","PName":"1111","Status":1},
		{"B":"23.2","L":"113.4","PName":"2222","Status":1},
		{"B":"22.9","L":"113.1","PName":"3333","Status":3004},
		{"B":"23.7","L":"113.8","PName":"第四个点","Status":1},
		{"B":"23.8","L":"113.5","PName":"第五个点","Status":1},
		{"B":"23.3","L":"113.2","PName":"第六个点","Status":1},
		{"B":"23.1","L":"113.7","PName":"7777","Status":1},
		{"B":"23.5","L":"113.3","PName":"8888","Status":1}];
		//这是页面需要的数据。实际应用中常用ajax获取。坐标点状态。点的类型。点的名字。


		var maxl = lnglats[0].L,minl=lnglats[0].L,maxb=lnglats[0].B,minb=lnglats[0].B;
		$.each(lnglats,
			function(i, res) {
				if(res.L > maxl) maxl =res.L;
				if(res.L < minl) minl =res.L;
				if(res.B > maxb) maxb =res.B;
				if(res.B < minb) minb =res.B;
			});

		var cenB =(parseFloat(maxb)+parseFloat(minb))/2;
		var cenL= (parseFloat(maxl)+parseFloat(minl))/2;
		var zoom = getZoom(maxl, minl, maxb, minb);

		//通过经纬度缩放级别
		function getZoom(maxJ, minJ, maxW, minW) {
			if (maxJ == minJ && maxW == minW) return 13;
			var diff = maxJ - minJ;
			if (diff < (maxW - minW) * 2.1) diff = (maxW - minW) * 2.1;
			diff = parseInt(10000 * diff) / 10000;

			var zoomArr = new Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13);
			var diffArr = new Array(180, 90, 45, 22, 11, 5.5, 2.75, 1.37, 0.68, 0.34, 0.17, 0.08, 0.04);

			for (var i = 0; i < diffArr.length; i++) {
				if ((diff - diffArr[i]) >= 0) {
					return zoomArr[i];
				}
			}
			return 14;
		}




		//加载基本地图和导航
		function loadMap(){
			try {
				map = new TMap("mapDiv"); //初始化地图对象
                              		if (zoom == 1) {  // 如果级别是1的话，就显示整张地图了。
                              			cenB = 0;
                              			cenL = 0;
                              		}
		                             map.centerAndZoom(new TLngLat(cenL, cenB), zoom);//设置显示地图的中心点和级别
		                             map.enableHandleMouseScroll(); //允许鼠标双击放大地图   
		                         } catch(err) {
		                         	alert('天地图加载不成功，请稍候再试！你可以先使用其他功能！');
		                         }
		                     }



	var iconMaker = [];//用来装标注点。
	var timer;//悬停的计时器。

	//把基站画到地图上,鼠标移动上去会显示基站名字
	function loadIcon(){
		//如果地图上有点，先清除。 这一段可以根据实际情况看要不要。
		if(iconMaker.length!=0){
			for(var m=0;m<iconMaker.length;m++){
				map.removeOverLay(iconMaker[m]);
			}
		}
		if (lnglats.length != 0) {
			var     iconurl ='images/pointOnline.jpg';
			var     iconurl1 = 'images/pointOffline.jpg';

			//两种图标，根据status判断用哪一种。
			var  icon = new TIcon(iconurl, new TSize(20, 20), {anchor: new TPixel(12, 12)});
			var   icon1 = new TIcon(iconurl1, new TSize(20, 20), {anchor: new TPixel(12, 12)});

			for (var i = 0; i < lnglats.length; i = i + 1) {
				//设置经纬度和图标。
				if (lnglats[i].Status == 1) {
					iconMaker[i]  = new TMarker(new TLngLat(lnglats[i].L, lnglats[i].B), {icon: icon});
				} else {
					iconMaker[i]  = new TMarker(new TLngLat(lnglats[i].L, lnglats[i].B), {icon: icon1});
				}

				iconMaker[i].id=i;
				// 绑定事件
				(function() {
					var m = iconMaker[i];
					markerclick = TEvent.addListener(m, "mouseover",function() {
                                                           		timer = setTimeout(mover, 500);//setTimeout不能带参数，所以用下面的方法处理。
                                                           		function mover() {
                                                           			onMouseOver(m);
                                                           		}
                                                           	});
					TEvent.addListener(m, "mouseout", onClose);
				})();
				map.addOverLay(iconMaker[i]);// 添加标注
			}
		}
	}

      	//鼠标从图标移动出去的时候执行
      	function onClose() {
      		clearTimeout(timer);
      		map.removeOverLay(customerWinInfo);
      	}

      	var label =[];
	//把标注点名字画到地图上
	function loadText(){
		if (lnglats.length != 0) {
			for (var i = 0; i < lnglats.length; i = i + 1) {
				var config = {
					text:lnglats[i].PName,
					offset:new TPixel(0,10),
					position:new TLngLat(lnglats[i].L,lnglats[i].B)
				};
	        			label[i]=new TLabel(config);//创建地图文本对象
	        			label[i].setAnchorPer([0.5,0]);//偏移量
	        			label[i].setBorderLine (0);
	        			map.addOverLay(label[i]);
	        			$('.stationByNum').parent().css({
	        				"padding":"0"
	        			});
	        		}
	        	}
	        }

	        var customerWinInfo;


            //鼠标移动到移动站上面的时候执行
            function onMouseOver(m) {
            	var html = [];
            	var status ='';
            	status = lnglats[m.id].Status == 1?'在线':'不在线';
            	html.push("	<div class='opt_station_hover' id='device_online'>");
            	html.push("		<ul class='opt_station_hover_ul'>");
            	html.push("			<li><span class='opt_li_left'>名称：</span>"+lnglats[m.id].PName +"</li>");
            	html.push("			<li><span class='opt_li_left'>在线状态：</span>"+status +"</li>");
            	html.push("			<img src='images/arrow.png'>");
            	html.push("		</ul>");
            	html.push("	</div>");
            	var config = {
            		offset:new TPixel(3,-60),
            		position:m.getLngLat()
            	};
            	customerWinInfo=new TLabel(config);
            	customerWinInfo.setTitle('');
            	customerWinInfo.setLabel(html.join(''));
            	customerWinInfo.setAnchorPer([0.5,0]);//偏移量
            	customerWinInfo.getObject().style.zIndex = 10000;
            	map.addOverLay(customerWinInfo);
            	$('.opt_station_hover').parent().css({
            		"border":"none",
            		"padding":"0",
            		"background-color":""
            	});
            }



            loadMap();
            loadIcon();
            loadText();
        </script>
    </body>
    </html>